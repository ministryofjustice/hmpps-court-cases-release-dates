{% extends "../../partials/prisonerLayout.njk" %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "hmpps/components/court-cases-release-dates/service-header/macro.njk" import serviceHeader %}
{% from "../../partials/adjustmentsIntercept.njk" import adjustmentsIntercept %}
{% from "../../partials/recalculationRequiredPanel.njk" import recalcRequiredPanel %}
{% from "hmpps/components/court-cases-release-dates/latest-calculation-card/macro.njk" import latestCalculationCard %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "hmpps/components/court-cases-release-dates/things-to-do/macro.njk" import thingsToDo %}

{% set pageTitle = "Court cases and release dates - overview" %}
{% set activeSubNav = 'overview' %}

{% if showAdjustments %}
  {%- set adjustmentAdditionSummarys = [] -%}

  {% for adjustmentType, adjustmentData in aggregatedAdjustments.ADDITION | dictsort %}
      {%- set adjustmentRow= {
        key: {
          text: adjustmentData.typeText
        },
        value: {
          text: adjustmentData.total + " Day" + ("s" if days != 1 else "")
        }
      } -%}
      {% set adjustmentAdditionSummarys = (adjustmentAdditionSummarys.push(adjustmentRow), adjustmentAdditionSummarys) %}
    {% endfor %}

  {%- set adjustmentDeductionSummarys = [] -%}

  {% for adjustmentType, adjustmentData in aggregatedAdjustments.DEDUCTION | dictsort %}
    {%- set extraText = "" -%}
    {%- set unused = adjustmentData.unused if adjustmentData.unused else 0 -%}
    {% if unused > 0 %}
      {%- set extraText = " including " + unused + " day" + ("s" if unused != 1 else "") + " unused" -%}
    {% endif %}
    {%- set adjustmentRow= {
      key: {
        text: adjustmentData.typeText
      },
      value: {
        text: adjustmentData.total + " Day" + ("s" if days != 1 else "") + extraText
      }
    } -%}
    {% set adjustmentDeductionSummarys = (adjustmentDeductionSummarys.push(adjustmentRow), adjustmentDeductionSummarys) %}
  {% endfor %}
{% endif %}

{% block content %}

  <h1 class="govuk-heading-xl">Overview</h1>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h2 class="govuk-heading-l">Release dates</h2>
      {% if not hasActiveSentences %}
        <p class="govuk-body">This person has no active sentences.</p>
        <p class="govuk-body">To calculate the release dates, you must enter active sentence information in NOMIS and <a id="try-again-no-active-sentences-id" data-qa="try-again-no-active-sentences-link" href=".">try again</a>.</p>
      {% elif isIndeterminateAndHasNoCalculatedDates %}
        <p class="govuk-body">This person is serving an indeterminate sentence and has no calculated dates.</p>
        <p class="govuk-body">You will need to <a id="manual-calc-link-id" data-qa="manual-calc-link" href="{{ calculateReleaseDatesUiUrl }}/calculation/{{ prisoner.prisonerNumber }}/reason">manually enter the approved dates</a>.</p>
      {% elif anyThingsToDo %}
        {{ thingsToDo(serviceDefinitions, 'all') }}
      {% elif latestCalculationConfig %}
        {{ latestCalculationCard(latestCalculationConfig) }}
      {% endif %}

      <p class="govuk-body govuk-!-margin-top-4">

        <a href="{{ calculateReleaseDatesUiUrl }}?prisonId={{ prisoner.prisonerNumber }}">View all release dates</a>

      </p>

      <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">

      {% if showAdjustments %}
        <h2 class="govuk-heading-l">Adjustments</h2>
        {% if aggregatedAdjustments.ADDITION | length or aggregatedAdjustments.DEDUCTION | length %}

          {% if adjustmentAdditionSummarys | length %}
            <h3 class="govuk-heading-m">Additions</h3>
            {{ govukSummaryList({
              rows: adjustmentAdditionSummarys,
              classes: "govuk-!-margin-bottom-7"
            }) }}

          {% endif %}

          {% if adjustmentDeductionSummarys | length %}
            <h3 class="govuk-heading-m">Deductions</h3>
            {{ govukSummaryList({
              rows: adjustmentDeductionSummarys,
              classes: "govuk-!-margin-bottom-7"
            }) }}

          {% endif %}

        {% else %}
          <p class="govuk-body govuk-!-margin-bottom-7">There are no active adjustments for {{ prisoner | firstNameSpaceLastName }}</p>
        {% endif %}

        <p class="govuk-body govuk-!-margin-top-4">
          <a href="{{ adjustmentsUiUrl }}/{{ prisoner.prisonerNumber }}">View all adjustments</a>
        </p>

        <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">

      {% endif %}

      {% if showRecalls %}
      <h3 class="govuk-heading-l">Recalls</h3>

      {% if latestRecall %}

        {{ recallCard(latestRecall) }}

      {{ govukButton({
        classes: "govuk-button--secondary",
        text: "Record a recall",
        preventDoubleClick: true,
        href: "{{ recallsUiUrl }}/person/{{ prisoner.prisonerNumber }}",
        attributes: { 'data-qa': 'create-new-recall-btn' }
      }) }}

      {% else %}
          <p> There are no recalls recorded.</p>
          {{ govukButton({
            classes: "govuk-button--secondary",
            text: "Record a recall",
            preventDoubleClick: true,
            href: recallsUiUrl + '/person/' + prisoner.prisonerNumber + '/recall/create/start?entrypoint=ccards',
            attributes: {  'data-qa': 'create-new-recall-btn' }
          }) }}
      {% endif %}

      <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">

      {% endif %}

      <h2 class="govuk-heading-l">Next court hearing</h2>

      {% if not (nextCourtEvent | length) %}
        <p class="govuk-body">There are no upcoming court hearings</p>
      {% else %}
        {{ govukSummaryList({
          rows: [
            {
              key: {
              text: "Case reference"
            },
              value: {
              text: nextCourtEvent.caseReference or 'Not entered'
            }
            },
            {
              key: {
              text: "Location"
            },
              value: {
              text: nextCourtEvent.courtLocation
            }
            },
            {
              key: {
              text: "Hearing type"
            },
              value: {
              html: nextCourtEvent.courtEventType
            }
            },
            {
              key: {
              text: "Date"
            },
              value: {
              text: nextCourtEvent.startTime | dateTime
            }
            }
          ]
        }) }}
      {% endif %}
      {% if hasReadOnlyNomisConfigAccess %}
        <h2 class="govuk-heading-l">Configuration</h2>
        <p><a href="/config">Configure Nomis read only screens</a></p>
      {% endif %}
    </div>
  </div>

  {% if immigrationDetentionEnabled %}
    <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
    <h2 class="govuk-heading-l" data-qa="immigration-detention-header">Immigration documents</h2>
    <br/>
    <p data-qa="immigration-detention-message">{{ immigrationDetentionMessage }}</p>
    <br/>
    {% if overviewImmigrationDetentionUrl %}
        <p><a data-qa="immigration-detention-overview-link" href={{ overviewImmigrationDetentionUrl }}>View all immigration documents</a></p>
    {% endif %}
    <p><a data-qa="immigration-detention-record-link" href={{ addImmigrationDetentionUrl }}>Record new immigration document</a></p>
  {% endif %}

{% endblock %}

{%  macro recallCard(recall) %}
  <div class="govuk-summary-card govuk-!-margin-bottom-6">
    <div class="govuk-summary-card__title-wrapper">
      <h2 class="govuk-summary-card__title">
         Recorded on {{ recall.createdAt | date }}{% if recall.locationName %} at {{ recall.locationName }}{% endif %}
      </h2>
      <ul class="govuk-summary-card__actions">
          {% if recall.source === 'NOMIS' %}
        <li class="govuk-summary-card__action">
          <span class="moj-badge moj-badge--grey govuk-!-margin-bottom-1 govuk-!-margin-left-1" data-qa="nomis-badge">NOMIS</span>
        </li>
        {% endif %}
          <li class="govuk-summary-card__action"><span class="govuk-visually-hidden"> recall recorded on {{ recall.recallDate | date }}</span>
        </li>
      </ul>

    </div>
    <div class="govuk-summary-card__content" id="recall-summary">
      <div class="govuk-grid-row govuk-!-padding-bottom-2 govuk-!-margin-top-2">
        <div class="govuk-grid-column-one-half">
          {{ cardInfo('Recall type', recall.recallType.description) }}
          {% if recall.source === 'NOMIS' %}
            {{ cardInfo('Revocation date', 'Not entered') }}
         {% else %}
          {{ cardInfo('Revocation date', recall.revocationDate | date) }}
        {% endif %}
        </div>
        <div class="govuk-grid-column-one-half">
          {{ cardInfo('Arrest date',  recall.returnToCustodyDate | date if recall.returnToCustodyDate else 'In prison at recall' ) }}
          
               {% if recall.source !== 'NOMIS' and recall.ualString %}
        {{ cardInfo('UAL (unlawfully at large)', recall.ualString) }}
      {% elseif recall.source !== 'NOMIS' and not recall.ual %}
      <h3 class="govuk-heading-s govuk-!-margin-bottom-1">UAL (unlawfully at large)</h3>
        <p class="govuk-body govuk-!-margin-bottom-2">
          <a class="govuk-link" href="{{ adjustmentsUiUrl }}/{{ prisoner.prisonerNumber }}" target="_blank" rel="noopener noreferrer">
            View UAL details
          </a>
        </p>
      {% elseif recall.source === 'NOMIS' %}
       <h3 class="govuk-heading-s govuk-!-margin-bottom-1">UAL (unlawfully at large)</h3>
        <p class="govuk-body govuk-!-margin-bottom-2">
          <a class="govuk-link" href="{{ adjustmentsUiUrl }}/{{ prisoner.prisonerNumber }}/unlawfully-at-large/view" target="_blank" rel="noopener noreferrer">
            View UAL details
          </a>
        </p>
      {% endif %}
        </div>
      </div>
       {% if recall.courtCases and recall.courtCases.length %}
      <div class="govuk-grid-row govuk-!-margin-top-4">
        <div class="govuk-grid-column-full">
          <h3 class="govuk-heading-s govuk-!-margin-bottom-1">Court cases</h3>
          <details class="govuk-details" data-module="govuk-details">
            <summary class="govuk-details__summary">
            <span class="govuk-details__summary-text" data-qa="recall-{{ recall.recallUuid }}-court-case-details">
              Court cases ({{ recall.courtCases.length }})
            </span>
            </summary>
            <div class="govuk-details__text govuk-!-margin-top-0" style="width: 100%; max-width: none;">
              {% for courtCase in recall.courtCases %}
                  {% set courtCaseIndex = loop.index %}
                  {% if courtCase.courtCaseReference or courtCase.courtName or courtCase.courtCaseDate %}
                    <h3 class="govuk-heading-m govuk-!-margin-top-6 govuk-!-margin-bottom-3"  data-qa="recall-{{ recall.recallUuid  }}-court-case-heading-{{ courtCaseIndex }}">
                      {% if courtCase.courtCaseReference %}
                        {{ courtCase.courtCaseReference }}{% if courtCase.courtName %} at {{ courtCase.courtName }}{% endif %}{% if courtCase.courtCaseDate %} on {{ courtCase.courtCaseDate | formatDate('DD/MM/YYYY') }}{% endif %}
                        {% elif courtCase.courtName %}
                        Case held at {{ courtCase.courtName }}{% if courtCase.courtCaseDate %} on {{ courtCase.courtCaseDate | formatDate('DD/MM/YYYY') }}{% endif %}
                        {% elif courtCase.courtCaseDate %}
                        Case on {{ courtCase.courtCaseDate | formatDate('DD/MM/YYYY') }}
                      {% endif %}
                    </h3>
                  {% endif %}

                  {% for sentence in courtCase.sentences %}
                    <div class="govuk-!-margin-top-2 govuk-!-margin-bottom-4"  data-qa="recall-{{ recall.recallUuid  }}-court-case-{{ courtCaseIndex }}-sentences-{{ loop.index }}">
                      {% set offenceStartDate = sentence.offenceStartDate | formatDate('DD/MM/YYYY') if sentence.offenceStartDate else 'Not entered' %}
                      {% set offenceEndDate = sentence.offenceEndDate | formatDate('DD/MM/YYYY') if sentence.offenceEndDate else null %}
                      {% set sentenceDate = sentence.sentenceDate | formatDate('DD/MM/YYYY') if sentence.sentenceDate else 'Not entered' %}
                      {# Determine numeric values for count and line number#}
                      {% if sentence.countNumber and sentence.countNumber != '-1' %}
                        {% set countNumberWithText = sentence.countNumber %}
                        {% set lineNumberWithText = null %}
                      {% elseif not sentence.countNumber %}
                        {% set countNumberWithText = null %}
                        {% set lineNumberWithText = sentence.lineNumber %}
                      {% else %}
                        {# countNumber is '-1' â†’ show neither#}
                        {% set countNumberWithText = null %}
                        {% set lineNumberWithText = null %}
                      {% endif %}

                      {{ offenceCard({
                        countNumber: countNumberWithText,
                        lineNumber: lineNumberWithText,
                        offenceCode: sentence.offenceCode | default('Not entered'),
                        offenceName: sentence.offenceDescription | default('Offence description not available'),
                        offenceStartDate: offenceStartDate,
                        offenceEndDate: offenceEndDate,
                        hideOutcome: true,
                        periodLengths: (sentence.periodLengths | default([])) | periodLengthsToSentenceLengths,
                        sentenceServeType: sentence.sentenceServeType | default(null),
                        sentenceType: sentence.sentenceTypeDescription | default('Not entered'),
                        sentenceDate: sentenceDate,
                        isSentenced: true,
                        detailsClasses: 'govuk-!-padding-4 offence-card-for-sentence-' + sentence.sentenceUiid
                      }) }}
                    </div>
                {% endfor %}
              {% endfor %}
            </div>
          </details>
        </div>
      </div>
    {% endif %}
    </div>
  </div>
{% endmacro %}

{% macro cardInfo(field, value) %}
  <h3 class="govuk-heading-s govuk-!-margin-bottom-1">{{ field }}</h3>
  <p class="govuk-body govuk-!-margin-bottom-2">{{ value }}</p>
{% endmacro %}
